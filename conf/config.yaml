# @package _global_
# DEFINITIVE FINAL VERSION: All paths fixed for SageMaker and full schema.

defaults:
  - _self_
  - instrument: mnq
  - experiment: sac_broad
  - override hydra/job_logging: default

debug_autograd_anomaly: false
use_mamba_nan_callback: true
mamba_nan_callback_freq: 500

data:
  data_dir: "/opt/ml/input/data/training"
  sagemaker_channel_name: training
  use_regime_splicing: true
  regime_definitions:
    train_High_Vol_Crash: [['2020-02-15', '2020-04-30']]
    train_Bull_Market:    [['2020-06-01', '2020-09-30']]
    train_Bear_Market:    [['2022-04-01', '2022-07-31']]
    train_Sideways_Chop:  [['2023-07-01', '2023-10-31']]
    train_Low_Vol_Grind:  [['2021-10-01', '2021-12-31']]
    validation_set:       [['2023-01-01', '2023-06-30']]
    test_set:             [['2024-01-01', '2024-12-31']]
  cleaning:
    min_allowable_price: 0.01
    outlier_rolling_window: 21 
    outlier_median_dev_threshold: 0.20

features:
  hurst_window: 151
  momentum_window: 48
  volatility_window: 12
  z_score_window: 60
  pct_change_cap: 0.05 
  hl_pct_cap: 0.05     
  hmm_n_components: 2
  hmm_min_samples: 500

environment:
  env_id: FuturesTradingEnv-v0
  max_episode_steps: 4096
  initial_balance: 50000.0
  add_bid_ask_spread: true      
  spread_ticks_min: 1           
  spread_ticks_max: 2           
  max_slippage_points: 0.25
  max_consecutive_holds_limit: 900
  lookback_window: 252
  min_lookback_hpo: 200
  max_lookback_hpo: 400
  reward_scheme: 'sac_shaped'
  action_threshold: 0.5
  activity_bonus_scale: 0.01
  hold_penalty_scale: 0.001
  win_bonus_scale: 0.5
  loss_penalty_scale: 1.0
  unrealized_loss_penalty_scale: 0.0

model:
  net_arch_pi_vf_options: [[64, 64], [128, 128]] 
  mlp_activation_fn_name: 'relu' 
  mamba_activation_fn_name: 'silu' 
  mamba_extractor_validation: {input_nan_inf_replacement: 0.0, input_clipping_value: 10.0} 
  mamba_d_conv_default: 2
  mamba_expand_default: 2

checkpointing:
  enabled: true
  save_freq: 10000
  s3_base_path: "/opt/ml/checkpoints"

optimization:
  n_trials: 1
  metric: 'sharpe'
  direction: 'maximize'
  pruning: 
    enabled: false
    n_startup_trials: 5
    n_warmup_steps: 10
    interval_steps: 1
  n_jobs: 1
  timeout_seconds: null
  trial_timesteps: 1000
  ppo_n_steps_choices_hpo: [256, 512]
  gae_lambda_min: 0.9
  gae_lambda_max: 0.98
  ent_coef_min: 0.0
  ent_coef_max: 0.01
  vf_coef_min: 0.5
  vf_coef_max: 0.6
  max_grad_norm_min: 0.5
  max_grad_norm_max: 5.0
  clip_range_min: 0.1
  clip_range_max: 0.3
  buffer_size_choices: [100000, 200000]
  tau_min: 0.005
  tau_max: 0.02
  train_freq_choices: [8, 16, 32]
  learning_starts: 10000
  activity_bonus_scale_min: 0.0
  activity_bonus_scale_max: 0.05
  hold_penalty_scale_min: 0.0
  hold_penalty_scale_max: 0.01
  win_bonus_scale_min: 0.1
  win_bonus_scale_max: 1.0
  loss_penalty_scale_min: 0.5
  loss_penalty_scale_max: 2.0
  unrealized_loss_penalty_scale_min: 0.0
  unrealized_loss_penalty_scale_max: 0.1
  lr_min: 1e-6
  lr_max: 1e-5
  batch_size_choices: [32, 64, 128, 256, 512]
  gamma_min: 0.98
  gamma_max: 0.999
  weight_decay_min: 0.0
  weight_decay_max: 1e-3
  mamba_layers_min: 1
  mamba_layers_max: 4
  mamba_d_model_choices: [64, 128]
  mamba_d_state_choices: [8, 16, 32]
  features_dim_choices: [128, 256]
  dropout_min: 0.0
  dropout_max: 0.2
  hurst_window_choices: [50, 100, 150]
  momentum_window_choices: [10, 21, 42, 48]
  volatility_window_choices: [10, 12, 21, 42]

training:
  total_timesteps: 1000000 
  use_vec_normalize: true 
  ppo_n_epochs: 10
  n_envs_final_train: 1
  use_subproc_vec_env: false

evaluation:
  deterministic_actions: true 

saving:
  output_dir: /opt/ml/output/data
  scaler_filename: ${instrument.symbol}_scaler.joblib
  optuna_study_name: ${instrument.symbol}_Opt_${experiment.name}
  optuna_db_name: /opt/ml/checkpoints/${instrument.symbol}_${experiment.name}_study.db
  best_params_filename: ${instrument.symbol}_best_params.joblib 
  final_model_filename: ${instrument.symbol}_final_model.zip 
  vec_normalize_filename: ${instrument.symbol}_vecnormalize_final.pkl
  trades_filename: test_trades.csv
  equity_filename: test_equity.csv
  report_filename: ${instrument.symbol}_report.html
  optuna_history_plot: optuna_history.png 
  optuna_importance_plot: optuna_importance.png 
  equity_curve_plot: equity_curve.png
  positions_plot: positions_plot.png
  log_filename: mamba_rl_trading.log
  checkpoint_dir_name: 'checkpoints'

device: auto 

hydra:
  run:
    dir: /opt/ml/output/data/hydra-runs/${now:%Y-%m-%d_%H-%M-%S}
  sweep:
    dir: /opt/ml/output/data/hydra-multirun/${now:%Y-%m-%d_%H-%M-%S}
    subdir: ${hydra.job.num}
